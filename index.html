<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="style.css" type="text/css">
	<title>lookup</title>
	<script src="d3.v3.min.js", type="text/javascript"></script>
	<script src="lookup.js" type="text/javascript"></script>
</head>

<body>
	<div id="container">
		<div id="timeline-chart">
			<div class="title">timeline-chart</div>
		</div>
		<div id="yearhist-chart">
			<div class="title">yearhist-chart</div>
		</div>
	</div>
	<script type="text/javascript">

	var dataset = [];
	var binsdata = {};
	var highlight = []; // To be an array giving years to be highlighted.
	var seriespadding = 5;  // Padding between each of the plotted time series in timeline.
	var noseries = 3; // TODO: Number of series we are plotting, this shouldn't be a magic number.
	// Axis and bin ticks.
	var fourriversTicks = 5;
	var leesferryTicks = 7;
	var pnaTicks = 7;

	var timelineMargin = {top: 20, right: 50, bottom: 20, left: 50};
	var timelineWidth = 660 - timelineMargin.left - timelineMargin.right;
	var timelineHeight = 300 - timelineMargin.top - timelineMargin.bottom;
	var timelineXScale = d3.scale.linear();
	var timelineFourRiversYScale = d3.scale.linear();
	var timelineLeesFerryYScale = d3.scale.linear();
	var timelinePNAYScale = d3.scale.linear();
	var timelineXAxis = d3.svg.axis();
	var timelineFourRiversYAxis = d3.svg.axis();
	var timelineLeesFerryYAxis = d3.svg.axis();
	var timelinePNAYAxis = d3.svg.axis();

	var previousScale = 1;  // This is so that we can differentiate zoom-panning from the actual zoom and use transitions accordingly in `zoomer()`.

	function highlightYears(x) {
		// To highlight obs in an array of years, d, in timeline-chart.
		d3.selectAll(".lineplotcircle.highlight").attr("class", "lineplot lineplotcircle");
		d3.selectAll(".lineplotcircle").filter(function(d) { return x.indexOf(d.Year) === -1 ? null : true; })
			.transition()
			.attr("class", "lineplot lineplotcircle highlight");
	}

	d3.csv("riverclimate.csv", function(error, data) {
		// TODO: Still need some error catching here.
		if (error) {
			console.log(error);
		} else {
			data.forEach(function(d, index) {
				// Convert strings to numbers and assign to `dataset`.
				var dkeys = d3.keys(d);
				var outgoing = {};
				for (var i = 0; i < dkeys.length; i++) {
					outgoing[dkeys[i]] = +d[dkeys[i]];
				}
				dataset[index] = outgoing;
			});
		// console.log(dataset); // DEBUG
		lookup.setData(dataset);
		}

		//// Awesome vis code here. //
		// Plotting the timeline.
		var serieschartHeight = timelineHeight / noseries - seriespadding;
		timelineFourRiversYScale.domain([d3.min(dataset, function(d) { return d["FourRivers"]; }),
								d3.max(dataset, function(d) { return d["FourRivers"]; })])
			.range([serieschartHeight, 0]);
		timelineLeesFerryYScale.domain([d3.min(dataset, function(d) { return d["LeesFerry"]; }),
								d3.max(dataset, function(d) { return d["LeesFerry"]; })])
			.range([serieschartHeight, 0]);
		timelinePNAYScale.domain([d3.min(dataset, function(d) { return d["PNA"]; }),
								d3.max(dataset, function(d) { return d["PNA"]; })])
			.range([serieschartHeight, 0]);
		timelineXScale.domain([d3.min(dataset, function(d) { return d["Year"]; }),
								d3.max(dataset, function(d) { return d["Year"]; })])
			.range([0, timelineWidth]);

		var zoom = d3.behavior.zoom()
			.x(timelineXScale)
			.scaleExtent([1, 8])
			.on("zoom", zoomer);

		timelineFourRiversYAxis.scale(timelineFourRiversYScale)
			.orient("left")
			.ticks(fourriversTicks)
			.tickFormat(d3.format("d"));
		timelineLeesFerryYAxis.scale(timelineLeesFerryYScale)
			.orient("left")
			.ticks(leesferryTicks)
			.tickFormat(d3.format("d"));
		timelinePNAYAxis.scale(timelinePNAYScale)
			.orient("left")
			.ticks(pnaTicks)
			.tickFormat(d3.format("d"));

		timelineXAxis.scale(timelineXScale)
			.orient("bottom")
			.tickFormat(d3.format("d"));

		var timelineFourRiversLine = d3.svg.line() // I think we're going to need this to be global.
			.x(function(d) { return timelineXScale(d["Year"]); })
			.y(function(d) { return timelineFourRiversYScale(d["FourRivers"]); });
		var timelineLeesFerryLine = d3.svg.line() // I think we're going to need this to be global.
			.x(function(d) { return timelineXScale(d["Year"]); })
			.y(function(d) { return timelineLeesFerryYScale(d["LeesFerry"]); });
		var timelinePNALine = d3.svg.line() // I think we're going to need this to be global.
			.x(function(d) { return timelineXScale(d["Year"]); })
			.y(function(d) { return timelinePNAYScale(d["PNA"]); });

		var timelineSvg = d3.select("#timeline-chart").append("svg")
			.attr("width", timelineWidth + timelineMargin.left + timelineMargin.right)
			.attr("heigh", timelineHeight + timelineMargin.top + timelineMargin.bottom);

		timelineSvg.append("g")
				.attr("id", "timelineplotspace")
				.attr("transform", "translate(" + timelineMargin.left + "," + timelineMargin.top + ")")
				// .call(zoom)
				.append("clipPath")
				.attr("id", "chart-clip")
				.append("rect")
				.attr("cy", 0)
				.attr("cx", 0)
				.attr("height", timelineHeight)
				.attr("width", timelineWidth);

		timelineSvg.select("#timelineplotspace").append("g")
			.attr("class", "series fourrivers")
			.attr("transform", "translate(0," + seriespadding / 2 + ")")
			.append("g")
			.attr("class", "series chart");
		timelineSvg.select("#timelineplotspace").append("g")
			.attr("class", "series leesferry")
			.attr("transform", "translate(0," + (timelineHeight / noseries + (seriespadding / 2)) + ")")
			.append("g")
			.attr("class", "series chart");
		timelineSvg.select("#timelineplotspace").append("g")
			.attr("class", "series pna")
			.attr("transform", "translate(0," + ((timelineHeight / noseries * 2) + (seriespadding / 2)) + ")")
			.append("g")
			.attr("class", "series chart");

		timelineSvg.selectAll(".series.chart")
			.append("rect")
			.attr("cy", 0)
			.attr("cx", 0)
			.attr("height", serieschartHeight)
			.attr("width", timelineWidth)
			.attr("class", "series chart background");

		timelineSvg.select(".series.fourrivers").select(".chart")			
			.append("path")
			.attr("class", "lineplot lineplotpath fourrivers")
			.attr("d", timelineFourRiversLine(dataset));
		timelineSvg.select(".series.fourrivers").select(".chart").selectAll("circle")
			.data(dataset)
			.enter()
			.append("circle")
			.attr("class", "lineplot lineplotcircle fourrivers")
			.attr("cy", function(d) {
				return timelineFourRiversYScale(d["FourRivers"]);
			})
			.attr("cx", function(d) {
				return timelineXScale(d["Year"]);
			})
			.attr("r", 4)
			.append("title")
			.text(function(d) {
				return d["FourRivers"] + " (" + d["Year"] + ")";
			});

		timelineSvg.select(".series.leesferry").select(".chart")
			.append("path")
			.attr("class", "lineplot lineplotpath leesferry")
			.attr("d", timelineLeesFerryLine(dataset));
		timelineSvg.select(".series.leesferry").select(".chart").selectAll("circle")
			.data(dataset)
			.enter()
			.append("circle")
			.attr("class", "lineplot lineplotcircle leesferry")
			.attr("cy", function(d) {
				return timelineLeesFerryYScale(d["LeesFerry"]);
			})
			.attr("cx", function(d) {
				return timelineXScale(d["Year"]);
			})
			.attr("r", 4)
			.append("title")
			.text(function(d) {
				return d["LeesFerry"] + " (" + d["Year"] + ")";
			});

		timelineSvg.select(".series.pna").select(".chart")
			.append("path")
			.attr("class", "lineplot lineplotpath pna")
			.attr("d", timelinePNALine(dataset));
		timelineSvg.select(".series.pna").select(".chart").selectAll("circle")
			.data(dataset)
			.enter()
			.append("circle")
			.attr("class", "lineplot lineplotcircle pna")
			.attr("cy", function(d) {
				return timelinePNAYScale(d["PNA"]);
			})
			.attr("cx", function(d) {
				return timelineXScale(d["Year"]);
			})
			.attr("r", 4)
			.append("title")
			.text(function(d) {
				return d["PNA"] + " (" + d["Year"] + ")";
			});

		timelineSvg.select("#timelineplotspace").append("g")
			.attr("class", "axis x")
			.attr("transform", "translate(0," + timelineHeight + ")")
			.call(timelineXAxis);

		timelineSvg.select(".series.fourrivers").append("g")
			.attr("class", "axis y")
			.call(timelineFourRiversYAxis);
		timelineSvg.select(".series.leesferry").append("g")
			.attr("class", "axis y")
			.call(timelineLeesFerryYAxis);
		timelineSvg.select(".series.pna").append("g")
			.attr("class", "axis y")
			.call(timelinePNAYAxis);

		timelineSvg.selectAll(".series.chart")
			.attr("clip-path", "url(#chart-clip)")
			.call(zoom);

		function zoomer() {
			// Called when zoom events are triggered. Transitions if zoom, not if panned.
			// console.log(d3.event.scale);  // DEBUG
			durationtime = 200;
			var t = d3.event.translate;
			var s = d3.event.scale;
			t[0] = Math.min(0, Math.max(timelineWidth * (1 - s), t[0]));			
			zoom.translate(t);
			if (s == previousScale) {
				timelineSvg.select("#timelineplotspace")
					.select(".axis.x")
					.call(timelineXAxis);
				timelineSvg.selectAll(".lineplotcircle")
					.attr("cx", function(d) {
						return timelineXScale(d["Year"]);
					});
				timelineSvg.select(".lineplotpath.fourrivers")
					.attr("d", timelineFourRiversLine(dataset));
				timelineSvg.select(".lineplotpath.leesferry")
					.attr("d", timelineLeesFerryLine(dataset));
				timelineSvg.select(".lineplotpath.pna")
					.attr("d", timelinePNALine(dataset));
			} else {
				timelineSvg.select("#timelineplotspace")
					.select(".axis.x")
					.transition()
					.duration(durationtime)
					.call(timelineXAxis);
				timelineSvg.selectAll(".lineplotcircle")
					.transition()
					.duration(durationtime)
					.attr("cx", function(d) {
						return timelineXScale(d["Year"]);
					});
				timelineSvg.select(".lineplotpath.fourrivers")
					.transition()
					.duration(durationtime)
					.attr("d", timelineFourRiversLine(dataset));
				timelineSvg.select(".lineplotpath.leesferry")
					.transition()
					.duration(durationtime)
					.attr("d", timelineLeesFerryLine(dataset));
				timelineSvg.select(".lineplotpath.pna")
					.transition()
					.duration(durationtime)
					.attr("d", timelinePNALine(dataset));
			}
			previousScale = d3.event.scale;
		}

		// Results single-year histogram.
		yearhistSvg = d3.select("#yearhist-chart").append("svg");
		
	});
	// console.log(dataset); // DEBUG
	</script>
</body>
</html>
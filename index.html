<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="style.css" type="text/css">
	<title>lookup</title>
	<script src="d3.min.js", type="text/javascript"></script>
	<script src="lookup.js" type="text/javascript"></script>
</head>

<body>
	<div id="container">
		<div id="timeline-chart">
			<div class="title">timeline-chart</div>
		</div>
		<div id="filter-chart">
			<div class="title">filter-chart</div>
		</div>
		<div id="yearhist-chart">
			<div class="title">yearhist-chart</div>
		</div>
	</div>
	<script type="text/javascript">
///////////////////////////////////////////////////////////////////////////////
	var dataset = [{"Year":1950,"FourRivers":14.44,"LeesFerry":13317921,"PNA":-0.6066666667},{"Year":1951,"FourRivers":22.95,"LeesFerry":12485833,"PNA":-0.3333333333},{"Year":1952,"FourRivers":28.6,"LeesFerry":20900043,"PNA":0.7166666667},{"Year":1953,"FourRivers":20.09,"LeesFerry":11204001,"PNA":-0.3716666667},{"Year":1954,"FourRivers":17.43,"LeesFerry":8368141,"PNA":-0.44},{"Year":1955,"FourRivers":10.98,"LeesFerry":9795470,"PNA":-1.0016666667},{"Year":1956,"FourRivers":29.89,"LeesFerry":11505097,"PNA":-0.1166666667},{"Year":1957,"FourRivers":14.89,"LeesFerry":20159803,"PNA":0.4383333333},{"Year":1958,"FourRivers":29.71,"LeesFerry":16899937,"PNA":-0.135},{"Year":1959,"FourRivers":12.05,"LeesFerry":9232537,"PNA":0.1933333333},{"Year":1960,"FourRivers":13.06,"LeesFerry":11974847,"PNA":0.3933333333},{"Year":1961,"FourRivers":11.97,"LeesFerry":9247778,"PNA":-0.605},{"Year":1962,"FourRivers":15.11,"LeesFerry":17769350,"PNA":-0.0783333333},{"Year":1963,"FourRivers":22.99,"LeesFerry":9259450,"PNA":0.1216666667},{"Year":1964,"FourRivers":10.92,"LeesFerry":10801202,"PNA":-0.7783333333},{"Year":1965,"FourRivers":25.64,"LeesFerry":18866401,"PNA":-0.4316666667},{"Year":1966,"FourRivers":12.95,"LeesFerry":11622229,"PNA":-1},{"Year":1967,"FourRivers":24.06,"LeesFerry":11808474,"PNA":-0.2433333333},{"Year":1968,"FourRivers":13.64,"LeesFerry":13508237,"PNA":-0.3483333333},{"Year":1969,"FourRivers":26.98,"LeesFerry":14849712,"PNA":0.6583333333},{"Year":1970,"FourRivers":24.06,"LeesFerry":15344263,"PNA":-0.4616666667},{"Year":1971,"FourRivers":22.57,"LeesFerry":15328915,"PNA":-1.0283333333},{"Year":1972,"FourRivers":13.43,"LeesFerry":12639988,"PNA":0.1916666667},{"Year":1973,"FourRivers":20.05,"LeesFerry":19454642,"PNA":-0.685},{"Year":1974,"FourRivers":32.5,"LeesFerry":13514611,"PNA":-0.0516666667},{"Year":1975,"FourRivers":19.23,"LeesFerry":17040250,"PNA":-0.3483333333},{"Year":1976,"FourRivers":8.22,"LeesFerry":11467038,"PNA":0.9383333333},{"Year":1977,"FourRivers":5.12,"LeesFerry":5629636,"PNA":0.2216666667}];
	var test = new Engine(3);

    function zoomer(d) {
        // Called when zoom events are triggered. Transitions if zoom, not if panned.
        // TODO: This is very poorly done. It would be great to clean it up and
        //       get this functionality into lookup.js.
        var k_time = test.time_key;
        var xScale = test.seriesPlotXScale;
        var durationtime = 200;
        var t = d3.event.translate;
        var s = d3.event.scale;
        test.zoom.translate(t);
        if (s == test.previousScale) {
            test.seriesPlotSvg.select("#timelineplotspace")
                .select(".axis.x")
                .call(test.seriesPlotXAxis);
            for (var i in test.var_keys) {
                var k = test.var_keys[i];
                var kScale = test.seriesPlotYScales[k];
                test.seriesPlotLines[k] = d3.svg.line()
                    .defined(function(d) { return d[k] != null; })  // Avoid `null` values.
                    .x(function(d) { return xScale(d[k_time]); })
                    .y(function(d) { return kScale(d[k]); });
                test.seriesPlotSvg.selectAll(".lineplotcircle")
                    .attr("cx", function(d) { return xScale(d[k_time]); });
                test.seriesPlotSvg.select(".lineplotpath." + k)
                    .attr("d", test.seriesPlotLines[k](test.dataset));
            }

        } else {
            test.seriesPlotSvg.select("#timelineplotspace")
                .select(".axis.x")
                .transition()
                .duration(durationtime)
                .call(test.seriesPlotXAxis);
            for (var i in test.var_keys) {
                var k = test.var_keys[i];
                var kScale = test.seriesPlotYScales[k];
                test.seriesPlotLines[k] = d3.svg.line()
                    .defined(function(d) { return d[k] != null; })  // Avoid `null` values.
                    .x(function(d) { return xScale(d[k_time]); })
                    .y(function(d) { return kScale(d[k]); });
                test.seriesPlotSvg.selectAll(".lineplotcircle")
                    .transition()
                    .duration(durationtime)
                    .attr("cx", function(d) { return xScale(d[k_time]); });
                test.seriesPlotSvg.select(".lineplotpath." + k)
                    .transition()
                    .duration(durationtime)
                    .attr("d", test.seriesPlotLines[k](test.dataset));
            }
        }
        test.previousScale = s;
    }

    function dragger(d) {
        // Called whenever drag events are fired. Intended to work on filterSvg circles.
        var classpool = d3.select(this).attr("class").split(" ");
        // Find the series (`s`) and position (`p`; "high" or "low") being referenced.
        var s = classpool.filter(function(e, i, a) { return test.var_keys.indexOf(e) != -1; })[0];
        var p = classpool.filter(function(e, i, a) { return ["high", "low"].indexOf(e) != -1; })[0];
        var v = test.seriesPlotYScales[s].invert(parseFloat(d3.event.y));
        if (p == "high") {
            test.setHighFilter(v, s, d.filterYear);
        } else if (p == "low") {
            test.setLowFilter(v, s, d.filterYear);
        } else {
            alert("Something went wrong with filter dragging.");
        }
        d3.select(this)
            .attr("cy", function(d) {
                return test.seriesPlotYScales[s](d[s][p]);
            })
            .select("title")
            .text(function(d) {
                return d[s][p] + " (" + d["filterYear"] + ")";
            });
        d3.select(".filterplotline." + s + "." + "fy" + d.filterYear)
            .attr("y1", function(d) {
                return test.seriesPlotYScales[s](d[s].low);
            })
            .attr("y2", function(d) {
                return test.seriesPlotYScales[s](d[s].high);
            });
        test.refilter();
    }


	test.setSeriesPlotWidth(660);
	test.setSeriesPlotHeight(800);
	test.setSeriesPlotTicks(5);
	test.setSeriesPlotPadding(12);
	test.setSeriesPlotMargin({top: 20, right: 50, bottom: 20, left: 150});

    test.setFilterPlotWidth(75);
    test.setFilterPlotHeight(800);
    test.setFilterPlotPadding(12);
    test.setFilterPlotMargin({top: 20, right: 50, bottom: 20, left: 150});

    test.setHistPlotWidth(260);
    test.setHistPlotHeight(800);
    test.setHistPlotPadding(12);
    test.setHistPlotMargin({top: 20, right: 50, bottom: 20, left: 150});


    d3.csv("riverclimate2.json", function(error, data) {
         // TODO: Still need some error catching here.
         if (error) {
             console.log(error);
         } else {
             data.forEach(function(d, index) {
                // Convert strings to numbers and assign to `dataset`.
                var dkeys = d3.keys(d);
                var outgoing = {};
                for (var i = 0; i < dkeys.length; i++) {
                    if (d[dkeys[i]] === "") {  // DEBUG
                        // console.log("should be null")
                        outgoing[dkeys[i]] = null;  // Maybe `undefined` instead of `null`.
                    } else {
                        outgoing[dkeys[i]] = +d[dkeys[i]];
                    }
                }
                dataset[index] = outgoing;
             });
         // console.log(dataset); // DEBUG
         test.setData(dataset, "Year");
         test.setSeriesPlotId("#timeline-chart");
         test.setFilterPlotId("#filter-chart");
         test.setHistPlotId("#yearhist-chart");

         test.drawPlots();
         }
    });
	// test.setHighFilter(0.5, "PNA", 0)
	// console.log(test.getMatchArray());
///////////////////////////////////////////////////////////////////////////////
// BELOW IS THE OLD TESTCASE.

	// var dataset = [];
	// var yearhistData = {};
	// var highlight = []; // To be an array giving years to be highlighted.
	// var seriespadding = 12;  // Padding between each of the plotted time series in timeline.
	// var noseries = 3; // TODO: Number of series we are plotting, this shouldn't be a magic number.
	// // Axis and bin ticks.
	// var fourriversTicks = 5;
	// var leesferryTicks = 5;
	// var pnaTicks = 5;
	// var filterXAxisTicks = 3;
	// // var yearhistXAxisTicks = 3;

	// var timelineMargin = {top: 20, right: 50, bottom: 20, left: 50};
	// var timelineWidth = 660 - timelineMargin.left - timelineMargin.right;
	// var timelineHeight = 300 - timelineMargin.top - timelineMargin.bottom;
	// var timelineXScale = d3.scale.linear();
	// var timelineFourRiversYScale = d3.scale.linear();
	// var timelineLeesFerryYScale = d3.scale.linear();
	// var timelinePNAYScale = d3.scale.linear();
	// var timelineXAxis = d3.svg.axis();
	// var timelineFourRiversYAxis = d3.svg.axis();
	// var timelineLeesFerryYAxis = d3.svg.axis();
	// var timelinePNAYAxis = d3.svg.axis();

	// var previousScale = 1;  // This is so that we can differentiate zoom-panning from the actual zoom and use transitions accordingly in `zoomer()`.

	// function highlightYears(x) {
	// 	// To highlight obs in an array of years, d, in timeline-chart.
	// 	d3.selectAll(".lineplotcircle.highlight").attr("class", "lineplot lineplotcircle");
	// 	d3.selectAll(".lineplotcircle").filter(function(d) { return x.indexOf(d.Year) === -1 ? null : true; })
	// 		.transition()
	// 		.attr("class", "lineplot lineplotcircle highlight");
	// }

	// function initYearhistData() {
	// 	// Initialize the YearHistData object before a filter has actually been created.
	// 	// yearhistData.FourRivers = [];
	// 	// yearhistData.LeesFerry = [];
	// 	// yearhistData.PNA = [];
	// 	yearhistData.FourRivers = d3.layout.histogram()
	// 		.bins(timelineFourRiversYScale.ticks(fourriversTicks))
	// 		(dataset.map(function(d) { return d.FourRivers; }));
	// 	yearhistData.LeesFerry = d3.layout.histogram()
	// 		.bins(timelineLeesFerryYScale.ticks(leesferryTicks))
	// 		(dataset.map(function(d) { return d.LeesFerry; }));
	// 	yearhistData.PNA = d3.layout.histogram()
	// 		.bins(timelinePNAYScale.ticks(pnaTicks))
	// 		(dataset.map(function(d) { return d.PNA; }));
	// }

	// d3.csv("riverclimate.json", function(error, data) {
	// 	// TODO: Still need some error catching here.
	// 	if (error) {
	// 		console.log(error);
	// 	} else {
	// 		data.forEach(function(d, index) {
	// 			// Convert strings to numbers and assign to `dataset`.
	// 			var dkeys = d3.keys(d);
	// 			var outgoing = {};
	// 			for (var i = 0; i < dkeys.length; i++) {
	// 				outgoing[dkeys[i]] = +d[dkeys[i]];
	// 			}
	// 			dataset[index] = outgoing;
	// 		});
	// 	// console.log(dataset); // DEBUG
	// 	lookup.setData(dataset);
	// 	}

	// 	//// Awesome vis code here. //
	// 	// Plotting the timeline.
	// 	var serieschartHeight = timelineHeight / noseries - seriespadding;
	// 	timelineFourRiversYScale.domain([d3.min(dataset, function(d) { return d["FourRivers"]; }),
	// 							d3.max(dataset, function(d) { return d["FourRivers"]; })])
	// 		.range([serieschartHeight, 0])
	// 		.nice(fourriversTicks);
	// 	timelineLeesFerryYScale.domain([d3.min(dataset, function(d) { return d["LeesFerry"]; }),
	// 							d3.max(dataset, function(d) { return d["LeesFerry"]; })])
	// 		.range([serieschartHeight, 0])
	// 		.nice(leesferryTicks);
	// 	timelinePNAYScale.domain([d3.min(dataset, function(d) { return d["PNA"]; }),
	// 							d3.max(dataset, function(d) { return d["PNA"]; })])
	// 		.range([serieschartHeight, 0]);
	// 	timelineXScale.domain([d3.min(dataset, function(d) { return d["Year"]; }),
	// 							d3.max(dataset, function(d) { return d["Year"]; })])
	// 		.range([0, timelineWidth]);

	// 	var zoom = d3.behavior.zoom()
	// 		.x(timelineXScale)
	// 		.scaleExtent([1, 8])
	// 		.on("zoom", zoomer);

	// 	// For drag behavior in filters.
	// 	var drag = d3.behavior.drag()
	// 		// .origin(Object)
	// 		.on("drag", dragger);

	// 	timelineFourRiversYAxis.scale(timelineFourRiversYScale)
	// 		.orient("left")
	// 		.ticks(fourriversTicks)
	// 		.tickFormat(d3.format("d"));
	// 	timelineLeesFerryYAxis.scale(timelineLeesFerryYScale)
	// 		.orient("left")
	// 		.ticks(leesferryTicks)
	// 		.tickFormat(d3.format("d"));
	// 	timelinePNAYAxis.scale(timelinePNAYScale)
	// 		.orient("left")
	// 		.ticks(pnaTicks)
	// 		.tickFormat(d3.format("d"));

	// 	timelineXAxis.scale(timelineXScale)
	// 		.orient("bottom")
	// 		.tickFormat(d3.format("d"));

	// 	var timelineFourRiversLine = d3.svg.line() // I think we're going to need this to be global.
	// 		.x(function(d) { return timelineXScale(d["Year"]); })
	// 		.y(function(d) { return timelineFourRiversYScale(d["FourRivers"]); });
	// 	var timelineLeesFerryLine = d3.svg.line() // I think we're going to need this to be global.
	// 		.x(function(d) { return timelineXScale(d["Year"]); })
	// 		.y(function(d) { return timelineLeesFerryYScale(d["LeesFerry"]); });
	// 	var timelinePNALine = d3.svg.line() // I think we're going to need this to be global.
	// 		.x(function(d) { return timelineXScale(d["Year"]); })
	// 		.y(function(d) { return timelinePNAYScale(d["PNA"]); });

	// 	var timelineSvg = d3.select("#timeline-chart").append("svg")
	// 		.attr("width", timelineWidth + timelineMargin.left + timelineMargin.right)
	// 		.attr("height", timelineHeight + timelineMargin.top + timelineMargin.bottom);

	// 	timelineSvg.append("g")
	// 			.attr("id", "timelineplotspace")
	// 			.attr("transform", "translate(" + timelineMargin.left + "," + timelineMargin.top + ")")
	// 			.append("clipPath")
	// 			.attr("id", "timeline-clip")
	// 			.append("rect")
	// 			.attr("cy", 0)
	// 			.attr("cx", 0)
	// 			.attr("height", timelineHeight)
	// 			.attr("width", timelineWidth);

	// 	timelineSvg.select("#timelineplotspace").append("g")
	// 		.attr("class", "series fourrivers")
	// 		.attr("transform", "translate(0," + seriespadding / 2 + ")")
	// 		.append("g")
	// 		.attr("class", "series chart");
	// 	timelineSvg.select("#timelineplotspace").append("g")
	// 		.attr("class", "series leesferry")
	// 		.attr("transform", "translate(0," + (timelineHeight / noseries + (seriespadding / 2)) + ")")
	// 		.append("g")
	// 		.attr("class", "series chart");
	// 	timelineSvg.select("#timelineplotspace").append("g")
	// 		.attr("class", "series pna")
	// 		.attr("transform", "translate(0," + ((timelineHeight / noseries * 2) + (seriespadding / 2)) + ")")
	// 		.append("g")
	// 		.attr("class", "series chart");

	// 	timelineSvg.selectAll(".series.chart")
	// 		.append("rect")
	// 		.attr("cy", 0)
	// 		.attr("cx", 0)
	// 		.attr("height", serieschartHeight)
	// 		.attr("width", timelineWidth)
	// 		.attr("class", "series chart background");

	
	// 	timelineSvg.select(".series.fourrivers").select(".chart")			
	// 		.append("path")
	// 		.attr("class", "lineplot lineplotpath fourrivers")
	// 		.attr("d", timelineFourRiversLine(dataset));
	// 	timelineSvg.select(".series.fourrivers").select(".chart").selectAll("circle")
	// 		.data(dataset)
	// 		.enter()
	// 		.append("circle")
	// 		.attr("class", "lineplot lineplotcircle fourrivers")
	// 		.attr("cy", function(d) {
	// 			return timelineFourRiversYScale(d["FourRivers"]);
	// 		})
	// 		.attr("cx", function(d) {
	// 			return timelineXScale(d["Year"]);
	// 		})
	// 		.attr("r", 4)
	// 		.append("title")
	// 		.text(function(d) {
	// 			return d["FourRivers"] + " (" + d["Year"] + ")";
	// 		});

	// 	timelineSvg.select(".series.leesferry").select(".chart")
	// 		.append("path")
	// 		.attr("class", "lineplot lineplotpath leesferry")
	// 		.attr("d", timelineLeesFerryLine(dataset));
	// 	timelineSvg.select(".series.leesferry").select(".chart").selectAll("circle")
	// 		.data(dataset)
	// 		.enter()
	// 		.append("circle")
	// 		.attr("class", "lineplot lineplotcircle leesferry")
	// 		.attr("cy", function(d) {
	// 			return timelineLeesFerryYScale(d["LeesFerry"]);
	// 		})
	// 		.attr("cx", function(d) {
	// 			return timelineXScale(d["Year"]);
	// 		})
	// 		.attr("r", 4)
	// 		.append("title")
	// 		.text(function(d) {
	// 			return d["LeesFerry"] + " (" + d["Year"] + ")";
	// 		});

	// 	timelineSvg.select(".series.pna").select(".chart")
	// 		.append("path")
	// 		.attr("class", "lineplot lineplotpath pna")
	// 		.attr("d", timelinePNALine(dataset));
	// 	timelineSvg.select(".series.pna").select(".chart").selectAll("circle")
	// 		.data(dataset)
	// 		.enter()
	// 		.append("circle")
	// 		.attr("class", "lineplot lineplotcircle pna")
	// 		.attr("cy", function(d) {
	// 			return timelinePNAYScale(d["PNA"]);
	// 		})
	// 		.attr("cx", function(d) {
	// 			return timelineXScale(d["Year"]);
	// 		})
	// 		.attr("r", 4)
	// 		.append("title")
	// 		.text(function(d) {
	// 			return d["PNA"] + " (" + d["Year"] + ")";
	// 		});

	// 	timelineSvg.select("#timelineplotspace").append("g")
	// 		.attr("class", "axis x")
	// 		.attr("transform", "translate(0," + timelineHeight + ")")
	// 		.call(timelineXAxis);

	// 	timelineSvg.select(".series.fourrivers").append("g")
	// 		.attr("class", "axis y")
	// 		.call(timelineFourRiversYAxis);
	// 	timelineSvg.select(".series.leesferry").append("g")
	// 		.attr("class", "axis y")
	// 		.call(timelineLeesFerryYAxis);
	// 	timelineSvg.select(".series.pna").append("g")
	// 		.attr("class", "axis y")
	// 		.call(timelinePNAYAxis);

	// 	timelineSvg.selectAll(".series.chart")
	// 		.attr("clip-path", "url(#timeline-clip)")
	// 		.call(zoom);

	// 	function zoomer() {
	// 		// Called when zoom events are triggered. Transitions if zoom, not if panned.
	// 		// console.log(d3.event.scale);  // DEBUG
	// 		durationtime = 200;
	// 		var t = d3.event.translate;
	// 		var s = d3.event.scale;
	// 		t[0] = Math.min(0, Math.max(timelineWidth * (1 - s), t[0]));			
	// 		zoom.translate(t);
	// 		if (s == previousScale) {
	// 			timelineSvg.select("#timelineplotspace")
	// 				.select(".axis.x")
	// 				.call(timelineXAxis);
	// 			timelineSvg.selectAll(".lineplotcircle")
	// 				.attr("cx", function(d) {
	// 					return timelineXScale(d["Year"]);
	// 				});
	// 			timelineSvg.select(".lineplotpath.fourrivers")
	// 				.attr("d", timelineFourRiversLine(dataset));
	// 			timelineSvg.select(".lineplotpath.leesferry")
	// 				.attr("d", timelineLeesFerryLine(dataset));
	// 			timelineSvg.select(".lineplotpath.pna")
	// 				.attr("d", timelinePNALine(dataset));
	// 		} else {
	// 			timelineSvg.select("#timelineplotspace")
	// 				.select(".axis.x")
	// 				.transition()
	// 				.duration(durationtime)
	// 				.call(timelineXAxis);
	// 			timelineSvg.selectAll(".lineplotcircle")
	// 				.transition()
	// 				.duration(durationtime)
	// 				.attr("cx", function(d) {
	// 					return timelineXScale(d["Year"]);
	// 				});
	// 			timelineSvg.select(".lineplotpath.fourrivers")
	// 				.transition()
	// 				.duration(durationtime)
	// 				.attr("d", timelineFourRiversLine(dataset));
	// 			timelineSvg.select(".lineplotpath.leesferry")
	// 				.transition()
	// 				.duration(durationtime)
	// 				.attr("d", timelineLeesFerryLine(dataset));
	// 			timelineSvg.select(".lineplotpath.pna")
	// 				.transition()
	// 				.duration(durationtime)
	// 				.attr("d", timelinePNALine(dataset));
	// 		}
	// 		previousScale = d3.event.scale;
	// 	}

	// 	// Plot for defining filters.
	// 	var filterMargin = {top: 20, right: 50, bottom: 20, left: 50};
	// 	var filterWidth = 260 - filterMargin.left - filterMargin.right;
	// 	var filterHeight = 300 - filterMargin.top - filterMargin.bottom;
	// 	var filterXScale = d3.scale.linear();
	// 	var filterXAxis = d3.svg.axis();
	// 	var filterSvg = d3.select("#filter-chart").append("svg")
	// 		.attr("width", filterWidth + filterMargin.left + filterMargin.right)
	// 		.attr("height", filterHeight + filterMargin.top + filterMargin.bottom);
	// 	filterXScale.domain([d3.min(lookup.filters, function(d) { return d["filterYear"]; }),
	// 							d3.max(lookup.filters, function(d) { return d["filterYear"]; })])
	// 		.range([0, filterWidth])
	// 		.nice(filterXAxisTicks);

	// 	filterXAxis.scale(filterXScale)
	// 		.ticks(filterXAxisTicks)
	// 		.orient("bottom")
	// 		.tickFormat(d3.format("d"));

	// 	filterSvg.append("g")
	// 			.attr("id", "filterplotspace")
	// 			.attr("transform", "translate(" + filterMargin.left + "," + filterMargin.top + ")")
	// 			.append("clipPath")
	// 			.attr("id", "filter-clip")
	// 			.append("rect")
	// 			.attr("cy", 0)
	// 			.attr("cx", 0)
	// 			.attr("height", filterHeight)
	// 			.attr("width", filterWidth);

	// 	filterSvg.select("#filterplotspace").append("g")
	// 		.attr("class", "series fourrivers")
	// 		.attr("transform", "translate(0," + seriespadding / 2 + ")")
	// 		.append("g")
	// 		.attr("class", "chart filter");
	// 	filterSvg.select("#filterplotspace").append("g")
	// 		.attr("class", "series leesferry")
	// 		.attr("transform", "translate(0," + (filterHeight / noseries + (seriespadding / 2)) + ")")
	// 		.append("g")
	// 		.attr("class", "chart filter");
	// 	filterSvg.select("#filterplotspace").append("g")
	// 		.attr("class", "series pna")
	// 		.attr("transform", "translate(0," + ((filterHeight / noseries * 2) + (seriespadding / 2)) + ")")
	// 		.append("g")
	// 		.attr("class", "chart filter");

	// 	filterSvg.selectAll(".filter.chart")
	// 		.append("rect")
	// 		.attr("cy", 0)
	// 		.attr("cx", 0)
	// 		.attr("height", serieschartHeight)
	// 		.attr("width", filterWidth)
	// 		.attr("class", "filter chart background");

	// 	// Adding the connecting line between circles for the filters chart.
	// 	filterSvg.select(".series.fourrivers").select(".chart").selectAll("line")
	// 		.data(lookup.filters)
	// 		.enter()
	// 		.append("line")
	// 		.attr("class", "filter filterplotline fourrivers")
	// 		.attr("y1", function(d) {
	// 			return timelineFourRiversYScale(d["FourRivers"].low);
	// 		})
	// 		.attr("x2", function(d) {
	// 			return filterXScale(d["filterYear"]);
	// 		})
	// 		.attr("y2", function(d) {
	// 			return timelineFourRiversYScale(d["FourRivers"].high);
	// 		})
	// 		.attr("x1", function(d) {
	// 			return filterXScale(d["filterYear"]);
	// 		});
	// 	filterSvg.select(".series.leesferry").select(".chart").selectAll("line")
	// 		.data(lookup.filters)
	// 		.enter()
	// 		.append("line")
	// 		.attr("class", "filter filterplotline leesferry")
	// 		.attr("y1", function(d) {
	// 			return timelineLeesFerryYScale(d["LeesFerry"].low);
	// 		})
	// 		.attr("x1", function(d) {
	// 			return filterXScale(d["filterYear"]);
	// 		})
	// 		.attr("y2", function(d) {
	// 			return timelineLeesFerryYScale(d["LeesFerry"].high);
	// 		})
	// 		.attr("x2", function(d) {
	// 			return filterXScale(d["filterYear"]);
	// 		});
	// 	filterSvg.select(".series.pna").select(".chart").selectAll("line")
	// 		.data(lookup.filters)
	// 		.enter()
	// 		.append("line")
	// 		.attr("class", "filter filterplotline pna")
	// 		.attr("y1", function(d) {
	// 			return timelinePNAYScale(d["PNA"].low);
	// 		})
	// 		.attr("x1", function(d) {
	// 			return filterXScale(d["filterYear"]);
	// 		})
	// 		.attr("y2", function(d) {
	// 			return timelinePNAYScale(d["PNA"].high);
	// 		})
	// 		.attr("x2", function(d) {
	// 			return filterXScale(d["filterYear"]);
	// 		});

	// 	// Adding the upper bounds circle for the filters chart.
	// 	filterSvg.select(".series.fourrivers").select(".chart").selectAll("circle.high")
	// 		.data(lookup.filters)
	// 		.enter()
	// 		.append("circle")
	// 		.attr("class", "filter filterplotcircle fourrivers high")
	// 		.attr("cy", function(d) {
	// 			return timelineFourRiversYScale(d["FourRivers"].high);
	// 		})
	// 		.attr("cx", function(d) {
	// 			return filterXScale(d["filterYear"]);
	// 		})
	// 		.attr("r", 4)
	// 		.append("title")
	// 		.text(function(d) {
	// 			return d["FourRivers"].high + " (" + d["filterYear"] + ")";
	// 		});
	// 	filterSvg.select(".series.leesferry").select(".chart").selectAll("circle.high")
	// 		.data(lookup.filters)
	// 		.enter()
	// 		.append("circle")
	// 		.attr("class", "filter filterplotcircle leesferry high")
	// 		.attr("cy", function(d) {
	// 			return timelineLeesFerryYScale(d["LeesFerry"].high);
	// 		})
	// 		.attr("cx", function(d) {
	// 			return filterXScale(d["filterYear"]);
	// 		})
	// 		.attr("r", 4)
	// 		.append("title")
	// 		.text(function(d) {
	// 			return d["LeesFerry"].high + " (" + d["filterYear"] + ")";
	// 		});
	// 	filterSvg.select(".series.pna").select(".chart").selectAll("circle.high")
	// 		.data(lookup.filters)
	// 		.enter()
	// 		.append("circle")
	// 		.attr("class", "filter filterplotcircle pna high")
	// 		.attr("cy", function(d) {
	// 			return timelinePNAYScale(d["PNA"].high);
	// 		})
	// 		.attr("cx", function(d) {
	// 			return filterXScale(d["filterYear"]);
	// 		})
	// 		.attr("r", 4)
	// 		.append("title")
	// 		.text(function(d) {
	// 			return d["PNA"].high + " (" + d["filterYear"] + ")";
	// 		});

	// 	// Adding the lower bounds circles for the filters chart.
	// 	filterSvg.select(".series.fourrivers").select(".chart").selectAll("circle.low")
	// 		.data(lookup.filters)
	// 		.enter()
	// 		.append("circle")
	// 		.attr("class", "filter filterplotcircle fourrivers low")
	// 		.attr("cy", function(d) {
	// 			return timelineFourRiversYScale(d["FourRivers"].low);
	// 		})
	// 		.attr("cx", function(d) {
	// 			return filterXScale(d["filterYear"]);
	// 		})
	// 		.attr("r", 4)
	// 		.append("title")
	// 		.text(function(d) {
	// 			return d["FourRivers"].low + " (" + d["filterYear"] + ")";
	// 		});
	// 	filterSvg.select(".series.leesferry").select(".chart").selectAll("circle.low")
	// 		.data(lookup.filters)
	// 		.enter()
	// 		.append("circle")
	// 		.attr("class", "filter filterplotcircle leesferry low")
	// 		.attr("cy", function(d) {
	// 			return timelineLeesFerryYScale(d["LeesFerry"].low);
	// 		})
	// 		.attr("cx", function(d) {
	// 			return filterXScale(d["filterYear"]);
	// 		})
	// 		.attr("r", 4)
	// 		.append("title")
	// 		.text(function(d) {
	// 			return d["LeesFerry"].low + " (" + d["filterYear"] + ")";
	// 		});
	// 	filterSvg.select(".series.pna").select(".chart").selectAll("circle.low")
	// 		.data(lookup.filters)
	// 		.enter()
	// 		.append("circle")
	// 		.attr("class", "filter filterplotcircle pna low")
	// 		.attr("cy", function(d) {
	// 			return timelinePNAYScale(d["PNA"].low);
	// 		})
	// 		.attr("cx", function(d) {
	// 			return filterXScale(d["filterYear"]);
	// 		})
	// 		.attr("r", 4)
	// 		.append("title")
	// 		.text(function(d) {
	// 			return d["PNA"].low + " (" + d["filterYear"] + ")";
	// 		});

	// 	filterSvg.select("#filterplotspace").append("g")
	// 		.attr("class", "axis x")
	// 		.attr("transform", "translate(0," + filterHeight + ")")
	// 		.call(filterXAxis);

	// 	filterSvg.selectAll(".filterplotcircle")
	// 		.call(drag);

	// 	function dragger(d) {
	// 		// Called whenever drag events are fired. Intended to work on filterSvg circles.
	// 		// TODO: Check for which series to return back to is a bit hackish. Consider this when redoing the data design.
	// 		if (d3.select(this).attr("class").indexOf("fourrivers") !== -1) {
	// 			if (d3.select(this).attr("class").indexOf("high") !== -1) {
	// 				lookup.setHighFilter(timelineFourRiversYScale.invert(parseFloat(d3.event.y)), "FourRivers", d.filterYear);
	// 				filterSvg.select(".series.fourrivers").select(".chart").selectAll("circle.high")
	// 					.attr("cy", function(d) {
	// 						return timelineFourRiversYScale(d["FourRivers"].high);
	// 					})
	// 					.attr("cx", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					})
	// 					.select("title")
	// 					.text(function(d) {
	// 						return d["FourRivers"].high + " (" + d["filterYear"] + ")";
	// 					});
	// 				filterSvg.select(".series.fourrivers").select(".chart").selectAll("line")
	// 					.attr("y1", function(d) {
	// 						return timelineFourRiversYScale(d["FourRivers"].low);
	// 					})
	// 					.attr("x2", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					})
	// 					.attr("y2", function(d) {
	// 						return timelineFourRiversYScale(d["FourRivers"].high);
	// 					})
	// 					.attr("x1", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					});
	// 			} else if (d3.select(this).attr("class").indexOf("low") !== -1) {
	// 				lookup.setLowFilter(timelineFourRiversYScale.invert(parseFloat(d3.event.y)), "FourRivers", d.filterYear);
	// 				filterSvg.select(".series.fourrivers").select(".chart").selectAll("circle.low")
	// 					.attr("cy", function(d) {
	// 						return timelineFourRiversYScale(d["FourRivers"].low);
	// 					})
	// 					.attr("cx", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					})
	// 					.select("title")
	// 					.text(function(d) {
	// 						return d["FourRivers"].low + " (" + d["filterYear"] + ")";
	// 					});
	// 				filterSvg.select(".series.fourrivers").select(".chart").selectAll("line")
	// 					.attr("y1", function(d) {
	// 						return timelineFourRiversYScale(d["FourRivers"].low);
	// 					})
	// 					.attr("x2", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					})
	// 					.attr("y2", function(d) {
	// 						return timelineFourRiversYScale(d["FourRivers"].high);
	// 					})
	// 					.attr("x1", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					});					
	// 			}
	// 		} else if (d3.select(this).attr("class").indexOf("leesferry") !== -1) {
	// 			if (d3.select(this).attr("class").indexOf("high") !== -1) {
	// 				lookup.setHighFilter(timelineLeesFerryYScale.invert(parseFloat(d3.event.y)), "LeesFerry", d.filterYear);
	// 				filterSvg.select(".series.leesferry").select(".chart").selectAll("circle.high")
	// 					.attr("cy", function(d) {
	// 						return timelineLeesFerryYScale(d["LeesFerry"].high);
	// 					})
	// 					.attr("cx", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					})
	// 					.select("title")
	// 					.text(function(d) {
	// 						return d["LeesFerry"].high + " (" + d["filterYear"] + ")";
	// 					});
	// 				filterSvg.select(".series.leesferry").select(".chart").selectAll("line")
	// 					.attr("y1", function(d) {
	// 						return timelineLeesFerryYScale(d["LeesFerry"].low);
	// 					})
	// 					.attr("x2", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					})
	// 					.attr("y2", function(d) {
	// 						return timelineLeesFerryYScale(d["LeesFerry"].high);
	// 					})
	// 					.attr("x1", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					});
	// 			} else if (d3.select(this).attr("class").indexOf("low") !== -1) {
	// 				lookup.setLowFilter(timelineLeesFerryYScale.invert(parseFloat(d3.event.y)), "LeesFerry", d.filterYear);
	// 				filterSvg.select(".series.leesferry").select(".chart").selectAll("circle.low")
	// 					.attr("cy", function(d) {
	// 						return timelineLeesFerryYScale(d["LeesFerry"].low);
	// 					})
	// 					.attr("cx", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					})
	// 					.select("title")
	// 					.text(function(d) {
	// 						return d["LeesFerry"].low + " (" + d["filterYear"] + ")";
	// 					});
	// 				filterSvg.select(".series.leesferry").select(".chart").selectAll("line")
	// 					.attr("y1", function(d) {
	// 						return timelineLeesFerryYScale(d["LeesFerry"].low);
	// 					})
	// 					.attr("x2", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					})
	// 					.attr("y2", function(d) {
	// 						return timelineLeesFerryYScale(d["LeesFerry"].high);
	// 					})
	// 					.attr("x1", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					});					
	// 			}
	// 		} else if (d3.select(this).attr("class").indexOf("pna") !== -1) {
	// 			if (d3.select(this).attr("class").indexOf("high") !== -1) {
	// 				lookup.setHighFilter(timelinePNAYScale.invert(parseFloat(d3.event.y)), "PNA", d.filterYear);
	// 				filterSvg.select(".series.pna").select(".chart").selectAll("circle.high")
	// 					.attr("cy", function(d) {
	// 						return timelinePNAYScale(d["PNA"].high);
	// 					})
	// 					.attr("cx", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					})
	// 					.select("title")
	// 					.text(function(d) {
	// 						return d["PNA"].high + " (" + d["filterYear"] + ")";
	// 					});
	// 				filterSvg.select(".series.pna").select(".chart").selectAll("line")
	// 					.attr("y1", function(d) {
	// 						return timelinePNAYScale(d["PNA"].low);
	// 					})
	// 					.attr("x2", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					})
	// 					.attr("y2", function(d) {
	// 						return timelinePNAYScale(d["PNA"].high);
	// 					})
	// 					.attr("x1", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					});
	// 			} else if (d3.select(this).attr("class").indexOf("low") !== -1) {
	// 				lookup.setLowFilter(timelinePNAYScale.invert(parseFloat(d3.event.y)), "PNA", d.filterYear);
	// 				filterSvg.select(".series.pna").select(".chart").selectAll("circle.low")
	// 					.attr("cy", function(d) {
	// 						return timelinePNAYScale(d["PNA"].low);
	// 					})
	// 					.attr("cx", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					})
	// 					.select("title")
	// 					.text(function(d) {
	// 						return d["PNA"].low + " (" + d["filterYear"] + ")";
	// 					});
	// 				filterSvg.select(".series.pna").select(".chart").selectAll("line")
	// 					.attr("y1", function(d) {
	// 						return timelinePNAYScale(d["PNA"].low);
	// 					})
	// 					.attr("x2", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					})
	// 					.attr("y2", function(d) {
	// 						return timelinePNAYScale(d["PNA"].high);
	// 					})
	// 					.attr("x1", function(d) {
	// 						return filterXScale(d["filterYear"]);
	// 					});					
	// 			}
	// 		} else {
	// 			alert("Something went wrong with filter dragging.");
	// 		}
	// 		refilter();
	// 	}

	// 	filterSvg.select(".series.fourrivers").append("g")
	// 		.attr("class", "axis y")
	// 		.call(timelineFourRiversYAxis);
	// 	filterSvg.select(".series.leesferry").append("g")
	// 		.attr("class", "axis y")
	// 		.call(timelineLeesFerryYAxis);
	// 	filterSvg.select(".series.pna").append("g")
	// 		.attr("class", "axis y")
	// 		.call(timelinePNAYAxis);

	// 	filterSvg.selectAll(".filter.chart")
	// 		.attr("clip-path", "url(#filter-clip)");

	// 	// Results single-year histogram.
	// 	initYearhistData();
	// 	var yearhistMargin = {top: 20, right: 50, bottom: 20, left: 50};
	// 	var yearhistWidth = 260 - yearhistMargin.left - yearhistMargin.right;
	// 	var yearhistHeight = 300 - yearhistMargin.top - yearhistMargin.bottom;
	// 	var yearhistXScale = d3.scale.linear();
	// 	var yearhistSvg = d3.select("#yearhist-chart").append("svg")
	// 		.attr("width", yearhistWidth + yearhistMargin.left + yearhistMargin.right)
	// 		.attr("height", yearhistHeight + yearhistMargin.top + yearhistMargin.bottom);
	// 	var yearhistXAxis = d3.svg.axis();
	// 	yearhistXScale.domain([0, lookup.dataset.length])
	// 		          .range([0, yearhistWidth])
	// 		          .nice();

	// 	yearhistXAxis.scale(yearhistXScale)
	// 		.orient("bottom")
	// 		.tickFormat(d3.format("d"));

	// 	yearhistSvg.append("g")
	// 			.attr("id", "yearhistplotspace")
	// 			.attr("transform", "translate(" + yearhistMargin.left + "," + yearhistMargin.top + ")")
	// 			.append("clipPath")
	// 			.attr("id", "yearhist-clip")
	// 			.append("rect")
	// 			.attr("cy", 0)
	// 			.attr("cx", 0)
	// 			.attr("height", yearhistHeight)
	// 			.attr("width", yearhistWidth);

	// 	yearhistSvg.select("#yearhistplotspace").append("g")
	// 		.attr("class", "series fourrivers")
	// 		.attr("transform", "translate(0," + seriespadding / 2 + ")")
	// 		.append("g")
	// 		.attr("class", "chart yearhist");
	// 	yearhistSvg.select("#yearhistplotspace").append("g")
	// 		.attr("class", "series leesferry")
	// 		.attr("transform", "translate(0," + (yearhistHeight / noseries + (seriespadding / 2)) + ")")
	// 		.append("g")
	// 		.attr("class", "chart yearhist");
	// 	yearhistSvg.select("#yearhistplotspace").append("g")
	// 		.attr("class", "series pna")
	// 		.attr("transform", "translate(0," + ((yearhistHeight / noseries * 2) + (seriespadding / 2)) + ")")
	// 		.append("g")
	// 		.attr("class", "chart yearhist");

	// 	yearhistSvg.selectAll(".yearhist.chart")
	// 		.append("rect")
	// 		.attr("cy", 0)
	// 		.attr("cx", 0)
	// 		.attr("height", serieschartHeight)
	// 		.attr("width", yearhistWidth)
	// 		.attr("class", "yearhist chart background");

	// 	yearhistSvg.select(".series.fourrivers").select(".chart").selectAll(".bar")
	// 		.data(yearhistData.FourRivers)
	// 		.enter()
	// 		.append("rect")
	// 		.attr("class", "yearhist yearhistplotrect fourrivers")
	// 		.attr("y", function(d) { return timelineFourRiversYScale(d.x + d.dx);
	// 		})			
	// 		.attr("x", 0)
	// 		.attr("height", function(d) {
	// 			return timelineFourRiversYScale(d.x) - timelineFourRiversYScale(d.dx + d.x);
	// 		})
	// 		.attr("width", 0)
	// 		.append("title")
	// 		.text(function(d) {
	// 			return d.y + " events (" + d.x + " - " + (d.x + d.dx) + ")";
	// 		});


	// 	yearhistSvg.select(".series.leesferry").select(".chart").selectAll(".bar")
	// 		.data(yearhistData.LeesFerry)
	// 		.enter()
	// 		.append("rect")
	// 		.attr("class", "yearhist yearhistplotrect leesferry")
	// 		.attr("y", function(d) { return timelineLeesFerryYScale(d.x + d.dx);
	// 		})
	// 		.attr("x", 0)
	// 		.attr("height", function(d) {
	// 			return timelineLeesFerryYScale(d.x) - timelineLeesFerryYScale(d.dx + d.x);
	// 		})
	// 		.attr("width", 0)
	// 		.append("title")
	// 		.text(function(d) {
	// 			return d.y + " events (" + d.x + " - " + (d.x + d.dx) + ")";
	// 		});

	// 	yearhistSvg.select(".series.pna").select(".chart").selectAll(".bar")
	// 		.data(yearhistData.PNA)
	// 		.enter()
	// 		.append("rect")
	// 		.attr("class", "yearhist yearhistplotrect pna")
	// 		.attr("y", function(d) { return timelinePNAYScale(d.x + d.dx);
	// 		})
	// 		.attr("x", 0)
	// 		.attr("height", function(d) {
	// 			return timelinePNAYScale(d.x) - timelinePNAYScale(d.dx + d.x);
	// 		})
	// 		.attr("width", 0)
	// 		.append("title")
	// 		.text(function(d) {
	// 			return d.y + " events (" + d.x + " - " + (d.x + d.dx) + ")";
	// 		});

	// 	yearhistSvg.select(".series.fourrivers").append("g")
	// 		.attr("class", "axis y")
	// 		.call(timelineFourRiversYAxis);
	// 	yearhistSvg.select(".series.leesferry").append("g")
	// 		.attr("class", "axis y")
	// 		.call(timelineLeesFerryYAxis);
	// 	yearhistSvg.select(".series.pna").append("g")
	// 		.attr("class", "axis y")
	// 		.call(timelinePNAYAxis);

	// 	yearhistSvg.select("#yearhistplotspace").append("g")
	// 		.attr("class", "axis x")
	// 		.attr("transform", "translate(0," + yearhistHeight + ")")
	// 		.call(yearhistXAxis);

	// 	yearhistSvg.selectAll(".filter.chart")
	// 		.attr("clip-path", "url(#filter-clip)");

	// 	function refreshYearhist(m) {
	// 		// Refresh the single year histogram given `m`, an array, like 
	// 		//`lookup.dataset`, which has an object for each target
	// 		// -not matched- year.

	// 		yearhistData.FourRivers = d3.layout.histogram()
	// 			.bins(timelineFourRiversYScale.ticks(fourriversTicks))
	// 			(m.map(function(d) { return d.FourRivers; }));
	// 		yearhistData.LeesFerry = d3.layout.histogram()
	// 			.bins(timelineLeesFerryYScale.ticks(leesferryTicks))
	// 			(m.map(function(d) { return d.LeesFerry; }));
	// 		yearhistData.PNA = d3.layout.histogram()
	// 			.bins(timelinePNAYScale.ticks(pnaTicks))
	// 			(m.map(function(d) { return d.PNA; }));

	// 		// OOoo, sexy.
	// 		yearhistXScale.domain([0, d3.max([d3.max(yearhistData.FourRivers.map(function(d){return d.y;})),
 //                                              d3.max(yearhistData.LeesFerry.map(function(d){return d.y;})),
 //                                              d3.max(yearhistData.PNA.map(function(d){return d.y;}))])]);

	// 		yearhistXAxis.scale(yearhistXScale);
	// 		yearhistSvg.select("#yearhistplotspace").selectAll(".axis.x")
	// 			.call(yearhistXAxis);

	// 		yearhistSvg.selectAll(".fourrivers.yearhistplotrect")
	// 			.data(yearhistData.FourRivers)
	// 			.attr("width", function(d) {
	// 				return yearhistXScale(d.y);
	// 			})
	// 			.select("title")
	// 			.text(function(d) {
	// 				return d.y + " events (" + d.x + " to " + (d.x + d.dx) + ")";
	// 			});
	// 		yearhistSvg.selectAll(".leesferry.yearhistplotrect")
	// 			.data(yearhistData.LeesFerry)
	// 			.attr("width", function(d) {
	// 				return yearhistXScale(d.y);
	// 			})
	// 			.select("title")
	// 			.text(function(d) {
	// 				return d.y + " events (" + d.x + " to " + (d.x + d.dx) + ")";
	// 			});				
	// 		yearhistSvg.selectAll(".pna.yearhistplotrect")
	// 			.data(yearhistData.PNA)
	// 			.attr("width", function(d) {
	// 				return yearhistXScale(d.y);
	// 			})
	// 			.select("title")
	// 			.text(function(d) {
	// 				return d.y + " events (" + d.x + " to " + (d.x + d.dx) + ")";
	// 			});				
	// 	}

	//     function refilter() {
	//     	// Rerun the lookup filter engine and refresh plots as needed.
	//     	var matched = lookup.getMatchArray();
	//     	highlightYears(matched.map(function(d) { return d.Year; }));
	//     	refreshYearhist(matched);
	//     }

	// });

	// console.log(dataset); // DEBUG
	</script>
</body>
</html>

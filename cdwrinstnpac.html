<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Lookupjs by brews</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <link rel="stylesheet" href="stylesheets/chart_styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>lookup</h1>
        <p>A tool to visually match short patterns across multiple time series. This is the HTML implementation.</p>

        <p><a href="https://github.com/brews/lookupjs/wiki/Tutorial">Tutorial</a></p>
        
        <p>California Department of Water Resources:<br>
          <small><a href="cdwrinstnpac.html">North Pacific</a></small><br>
          <small><a href="cdwrinsteqpac.html">Equatorial Pacific</a></small><br>
          <small><a href="cdwrpaleonpac.html">Paleo North Pacific</a></small><br>
          <small><a href="cdwrpaleoeqpac.html">Paleo Equatorial Pacific</a></small><br>
        </p>


        <p>Salt River Project:<br>
          <small>Raw data (<a href="srprawfull.html">Full</a>|<a href="srprawcrop.html">Crop</a>)</small><br>
          <small>Rank percentiles (<a href="srpprankfull.html">Full</a>|<a href="srpprankcrop.html">Crop</a>)</small><br>
          <small>Percent of mean (<a href="srppmeanfull.html">Full</a>|<a href="srppmeancrop.html">Crop</a>)</small>
        </p>

        <p class="view"><a href="https://github.com/brews/lookupjs">View the Project on GitHub <small>brews/lookupjs</small></a></p>

        <ul>
          <li><a href="https://github.com/brews/lookupjs/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/brews/lookupjs/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/brews/lookupjs">View On <strong>GitHub</strong></a></li>
        </ul>

      </header>
      <section>
        <h1>
<a name="lookup" class="anchor" href="#lookup"><span class="octicon octicon-link"></span></a>California Department of Water Resources: North Pacific</h1>
      </section>
      <section>
        <p>This version of lookup focuses on patterns between the Sacramento River ("Sacramento"), the Colorado River ("LeesFerry"), North Pacific Index anomalies ("NPI"), and the Aleutian Low Pressure Index ("ALPI").</p>
        <p>The data is described in detail below.</p>
      </section>
      <section>
        <div id="container">
          <div id="timeline-chart", class="charts">
            <div class="title"></div>
          </div>
          <div id="filter-chart", class="charts">
            <div class="title"></div>
          </div>
          <div id="yearhist-chart", class="charts">
            <div class="title"></div>
          </div>
        </div>
      </section>
      <section>
        <p>"Sacramento" is a <a href="http://water.usgs.gov/nwc/explain_data.html">water year</a> time series of unimpaired runoff, or full natural flow, for the <a href="http://en.wikipedia.org/wiki/Sacramento_River">Sacramento River</a>. The data has been transformed into rank-percentiles. The series is the sum of natural flow from four river gauges: <a href="http://cdec.water.ca.gov/cgi-progs/staMeta?station_id=BND">Sacramento River at Bend Bridge</a>, <a href="http://cdec.water.ca.gov/cgi-progs/staMeta?station_id=FTO">Feather River at Oroville</a>, <a href="http://cdec.water.ca.gov/cgi-progs/staMeta?station_id=YRS">Yuba River near Smartville</a>, and <a href="http://cdec.water.ca.gov/cgi-progs/staMeta?station_id=AMF">American River at Folsom Lake</a>. This index is also known as the "Four River Index" or "Four Basin Index".</p>

        <p>"LeesFerry" is a <a href="http://water.usgs.gov/nwc/explain_data.html">water year</a> time series of  natural flow for the <a href="http://en.wikipedia.org/wiki/Colorado_River">Colorado River</a>. The data has been transformed into rank-percentiles. The data is calculated from the Lee's Ferry river gauge. This gauge measures the Colorado River streamflow from the Upper Colorado River basin. <a href="http://www.usbr.gov/lc/region/g4000/NaturalFlow/documentation.html">Source</a>.</p>

        <p>"ALPI" is the Aleutian Low Pressure Index from December through March (<a href="http://dx.doi.org/10.1139/f96-310">Beamish et al. 1997</a>, Beamish et al. 2000). This index measures the size of the <a href="http://en.wikipedia.org/wiki/Aleutian_Low">Aleutian Low</a>.</p>

        <p>"NPI" are North Pacific Index anomalies from November through March (<a href="http://dx.doi.org/10.1007/BF00204745">Trenberth and Hurrell 1994</a>). The index is the area-weighted sea-level pressure of the <a href="http://en.wikipedia.org/wiki/Aleutian_Low">Aleutian Low</a>. See <a href="https://climatedataguide.ucar.edu/climate-data/north-pacific-np-index-trenberth-and-hurrell-monthly-and-winter">here</a> for further discussion.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/brews">brews</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Modified from theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    <script src="javascripts/d3.v3.min.js", type="text/javascript"></script>
    <script src="javascripts/lookup.js" type="text/javascript"></script>
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      try {
        var pageTracker = _gat._getTracker("UA-42669371-1");
        pageTracker._trackPageview();
      } catch(err) {}
    </script>
    <script type="text/javascript">

    var test = new Engine(3);
    var dataset = [];

    function zoomer(d) {
      // Called when zoom events are triggered. Transitions if zoom, not if panned.
      // TODO: This is very poorly done. It would be great to clean it up and
      //       get this functionality into lookup.js.
      var k_time = test.time_key;
      var xScale = test.seriesPlotXScale;
      var durationtime = 400;
      var t = d3.event.translate;
      var s = d3.event.scale;
      test.zoom.translate(t);
      if (s == test.previousScale) {
          test.seriesPlotSvg.select("#timelineplotspace")
              .select(".axis.x")
              .call(test.seriesPlotXAxis);
          for (var i in test.var_keys) {
              var k = test.var_keys[i];
              var kScale = test.seriesPlotYScales[k];
              test.seriesPlotLines[k] = d3.svg.line()
                  .defined(function(d) { return d[k] != null; })  // Avoid `null` values.
                  .x(function(d) { return xScale(d[k_time]); })
                  .y(function(d) { return kScale(d[k]); });
              test.seriesPlotSvg.selectAll(".lineplotcircle")
                  .attr("cx", function(d) { return xScale(d[k_time]); });
              test.seriesPlotSvg.select(".lineplotpath." + k)
                  .attr("d", test.seriesPlotLines[k](test.dataset));
          }
      } else {
          test.seriesPlotSvg.select("#timelineplotspace")
              .select(".axis.x")
              .transition()
              .duration(durationtime)
              .call(test.seriesPlotXAxis);
          for (var i in test.var_keys) {
              var k = test.var_keys[i];
              var kScale = test.seriesPlotYScales[k];
              test.seriesPlotLines[k] = d3.svg.line()
                  .defined(function(d) { return d[k] != null; })  // Avoid `null` values.
                  .x(function(d) { return xScale(d[k_time]); })
                  .y(function(d) { return kScale(d[k]); });
              test.seriesPlotSvg.selectAll(".lineplotcircle")
                  .transition()
                  .duration(durationtime)
                  .attr("cx", function(d) { return xScale(d[k_time]); });
              test.seriesPlotSvg.select(".lineplotpath." + k)
                  .transition()
                  .duration(durationtime)
                  .attr("d", test.seriesPlotLines[k](test.dataset));
          }
      }
      test.previousScale = s;
    }

    function dragger(d) {
      // Called whenever drag events are fired. Intended to work on filterSvg circles.
      var classpool = d3.select(this).attr("class").split(" ");
      // Find the series (`s`) and position (`p`; "high" or "low") being referenced.
      var s = classpool.filter(function(e, i, a) { return test.var_keys.indexOf(e) != -1; })[0];
      var p = classpool.filter(function(e, i, a) { return ["high", "low"].indexOf(e) != -1; })[0];
      var v = test.seriesPlotYScales[s].invert(parseFloat(d3.event.y));
      if (p == "high") {
          test.setHighFilter(v, s, d.filterYear);
      } else if (p == "low") {
          test.setLowFilter(v, s, d.filterYear);
      } else {
          alert("Something went wrong with filter dragging.");
      }
      d3.select(this)
          .attr("cy", function(d) {
              return test.seriesPlotYScales[s](d[s][p]);
          })
          .select("title")
          .text(function(d) {
              return d[s][p] + " (" + d["filterYear"] + ")";
          });
      d3.select(".filterplotline." + s + "." + "fy" + d.filterYear)
          .attr("y1", function(d) {
              return test.seriesPlotYScales[s](d[s].low);
          })
          .attr("y2", function(d) {
              return test.seriesPlotYScales[s](d[s].high);
          });
      test.refilter();
    }


    test.setSeriesPlotWidth(360);
    test.setSeriesPlotHeight(350);
    test.setSeriesPlotTicks(5);
    test.setSeriesPlotPadding(20);
    test.setSeriesPlotMargin({top: 20, right: 50, bottom: 20, left: 125});

    test.setFilterPlotWidth(75);
    test.setFilterPlotHeight(350);
    test.setFilterPlotPadding(20);
    test.setFilterPlotMargin({top: 20, right: 50, bottom: 20, left: 125});

    test.setHistPlotWidth(75);
    test.setHistPlotHeight(350);
    test.setHistPlotPadding(20);
    test.setHistPlotMargin({top: 20, right: 50, bottom: 20, left: 125});


    d3.csv("plotdata/cdwrinstpi.json", function(error, data) {
       // TODO: Still need some error catching here.
       if (error) {
           console.log(error);
       } else {
           data.forEach(function(d, index) {
              // Convert strings to numbers and assign to `dataset`.
              var dkeys = d3.keys(d);
              var outgoing = {};
              for (var i = 0; i < dkeys.length; i++) {
                  if (d[dkeys[i]] === "") {  // DEBUG
                      // console.log("should be null")
                      outgoing[dkeys[i]] = null;  // Maybe `undefined` instead of `null`.
                  } else {
                      outgoing[dkeys[i]] = +d[dkeys[i]];
                  }
              }
              dataset[index] = outgoing;
           });
       // console.log(dataset); // DEBUG
       test.setData(dataset, "Year");
       test.setSeriesPlotId("#timeline-chart");
       test.setFilterPlotId("#filter-chart");
       test.setHistPlotId("#yearhist-chart");

       test.drawPlots();
       }
    });
      </script>
  </body>
</html>

<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Lookupjs by brews</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <link rel="stylesheet" href="stylesheets/chart_styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>lookup</h1>
        <p>A tool to visually match short patterns across multiple time series. This is the HTML implementation.</p>

        <p>California Water:<br>
          <small><a href="index.html">Demo</a></small>
        </p>

        <p>Salt River Project:<br>
          <small>Raw data (<a href="srprawfull.html">Full</a>|<a href="srprawcrop.html">Crop</a>)</small><br>
          <small>Rank percentiles (<a href="srpprankfull.html">Full</a>|<a href="srpprankcrop.html">Crop</a>)</small><br>
          <small>Percent of mean (<a href="srppmeanfull.html">Full</a>|<a href="srppmeancrop.html">Crop</a>)</small>
        </p>

        <p class="view"><a href="https://github.com/brews/lookupjs">View the Project on GitHub <small>brews/lookupjs</small></a></p>

        <ul>
          <li><a href="https://github.com/brews/lookupjs/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/brews/lookupjs/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/brews/lookupjs">View On <strong>GitHub</strong></a></li>
        </ul>

      </header>
      <section>
        <h1>
<a name="lookup" class="anchor" href="#lookup"><span class="octicon octicon-link"></span></a>Salt River Project: Percent of mean - Full</h1>
      </section>
      <section>
        <p>The timeline chart can zoom in by double clicking on it, and zoom out by selecting the shift key and double clicking again. You can also use a mouse-wheel if you have one. The middle "filter" chart lets you define a range of values for three consecutive years in each of the series. You can do this by dragging each circle on the top and bottom end of the filters. After a filter has been changed, Lookup will find strings of years in the series where all of the filters have matches. The single year that follows this matched pattern is highlighted in orange in the timeline chart. You will also notice that the bottome "single-year histogram" summarizes the distribution of the single year that follows each matched pattern, for each series.</p>
        <p>Placing your mouse over any of the circles or bars in these charts will bring up a brief tool tip describing the feature.</p>
      </section>
      <section>
        <div id="container">
          <div id="timeline-chart", class="charts">
            <div class="title">timeline</div>
          </div>
          <div id="filter-chart", class="charts">
            <div class="title">filter</div>
          </div>
          <div id="yearhist-chart", class="charts">
            <div class="title">single-year histogram</div>
          </div>
        </div>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/brews">brews</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    <script src="javascripts/d3.v3.min.js", type="text/javascript"></script>
    <script src="javascripts/lookup.js" type="text/javascript"></script>
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      try {
        var pageTracker = _gat._getTracker("UA-42669371-1");
        pageTracker._trackPageview();
      } catch(err) {}
    </script>
    <script type="text/javascript">

    var test = new Engine(3);
    var dataset = [];

    function zoomer(d) {
      // Called when zoom events are triggered. Transitions if zoom, not if panned.
      // TODO: This is very poorly done. It would be great to clean it up and
      //       get this functionality into lookup.js.
      var k_time = test.time_key;
      var xScale = test.seriesPlotXScale;
      var durationtime = 400;
      var t = d3.event.translate;
      var s = d3.event.scale;
      test.zoom.translate(t);
      if (s == test.previousScale) {
          test.seriesPlotSvg.select("#timelineplotspace")
              .select(".axis.x")
              .call(test.seriesPlotXAxis);
          for (var i in test.var_keys) {
              var k = test.var_keys[i];
              var kScale = test.seriesPlotYScales[k];
              test.seriesPlotLines[k] = d3.svg.line()
                  .defined(function(d) { return d[k] != null; })  // Avoid `null` values.
                  .x(function(d) { return xScale(d[k_time]); })
                  .y(function(d) { return kScale(d[k]); });
              test.seriesPlotSvg.selectAll(".lineplotcircle")
                  .attr("cx", function(d) { return xScale(d[k_time]); });
              test.seriesPlotSvg.select(".lineplotpath." + k)
                  .attr("d", test.seriesPlotLines[k](test.dataset));
          }
      } else {
          test.seriesPlotSvg.select("#timelineplotspace")
              .select(".axis.x")
              .transition()
              .duration(durationtime)
              .call(test.seriesPlotXAxis);
          for (var i in test.var_keys) {
              var k = test.var_keys[i];
              var kScale = test.seriesPlotYScales[k];
              test.seriesPlotLines[k] = d3.svg.line()
                  .defined(function(d) { return d[k] != null; })  // Avoid `null` values.
                  .x(function(d) { return xScale(d[k_time]); })
                  .y(function(d) { return kScale(d[k]); });
              test.seriesPlotSvg.selectAll(".lineplotcircle")
                  .transition()
                  .duration(durationtime)
                  .attr("cx", function(d) { return xScale(d[k_time]); });
              test.seriesPlotSvg.select(".lineplotpath." + k)
                  .transition()
                  .duration(durationtime)
                  .attr("d", test.seriesPlotLines[k](test.dataset));
          }
      }
      test.previousScale = s;
    }

    function dragger(d) {
      // Called whenever drag events are fired. Intended to work on filterSvg circles.
      var classpool = d3.select(this).attr("class").split(" ");
      // Find the series (`s`) and position (`p`; "high" or "low") being referenced.
      var s = classpool.filter(function(e, i, a) { return test.var_keys.indexOf(e) != -1; })[0];
      var p = classpool.filter(function(e, i, a) { return ["high", "low"].indexOf(e) != -1; })[0];
      var v = test.seriesPlotYScales[s].invert(parseFloat(d3.event.y));
      if (p == "high") {
          test.setHighFilter(v, s, d.filterYear);
      } else if (p == "low") {
          test.setLowFilter(v, s, d.filterYear);
      } else {
          alert("Something went wrong with filter dragging.");
      }
      d3.select(this)
          .attr("cy", function(d) {
              return test.seriesPlotYScales[s](d[s][p]);
          })
          .select("title")
          .text(function(d) {
              return d[s][p] + " (" + d["filterYear"] + ")";
          });
      d3.select(".filterplotline." + s + "." + "fy" + d.filterYear)
          .attr("y1", function(d) {
              return test.seriesPlotYScales[s](d[s].low);
          })
          .attr("y2", function(d) {
              return test.seriesPlotYScales[s](d[s].high);
          });
      test.refilter();
    }


    test.setSeriesPlotWidth(360);
    test.setSeriesPlotHeight(350);
    test.setSeriesPlotTicks(5);
    test.setSeriesPlotPadding(20);
    test.setSeriesPlotMargin({top: 20, right: 50, bottom: 20, left: 125});

    test.setFilterPlotWidth(75);
    test.setFilterPlotHeight(350);
    test.setFilterPlotPadding(20);
    test.setFilterPlotMargin({top: 20, right: 50, bottom: 20, left: 125});

    test.setHistPlotWidth(75);
    test.setHistPlotHeight(350);
    test.setHistPlotPadding(20);
    test.setHistPlotMargin({top: 20, right: 50, bottom: 20, left: 125});


    d3.csv("plotdata/srppmeanfull.json", function(error, data) {
       // TODO: Still need some error catching here.
       if (error) {
           console.log(error);
       } else {
           data.forEach(function(d, index) {
              // Convert strings to numbers and assign to `dataset`.
              var dkeys = d3.keys(d);
              var outgoing = {};
              for (var i = 0; i < dkeys.length; i++) {
                  if (d[dkeys[i]] === "") {  // DEBUG
                      // console.log("should be null")
                      outgoing[dkeys[i]] = null;  // Maybe `undefined` instead of `null`.
                  } else {
                      outgoing[dkeys[i]] = +d[dkeys[i]];
                  }
              }
              dataset[index] = outgoing;
           });
       // console.log(dataset); // DEBUG
       test.setData(dataset, "WY");
       test.setSeriesPlotId("#timeline-chart");
       test.setFilterPlotId("#filter-chart");
       test.setHistPlotId("#yearhist-chart");

       test.drawPlots();
       }
    });
      </script>
  </body>
</html>
